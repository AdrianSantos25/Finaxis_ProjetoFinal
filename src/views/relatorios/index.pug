extends ../layout

block content
  //- Cabeçalho com título e seletor de ano
  .card.mb-4.border-0.shadow-sm
    .card-body.py-3
      .d-flex.justify-content-between.align-items-center.flex-wrap.gap-3
        .d-flex.align-items-center
          .bg-primary.text-white.summary-icon-circle.me-3
            i.bi.bi-graph-up
          div
            h1.h3.mb-0 Relatórios Anuais
            p.text-muted.mb-0 Análise financeira de #{ano}
        .d-flex.align-items-center.gap-2
          a.btn.btn-outline-success(href=`/relatorios/exportar/csv?ano=${ano}` title="Exportar CSV")
            i.bi.bi-file-earmark-spreadsheet.me-1
            | Exportar CSV
          .btn-group
            each anoOpcao in anosDisponiveis
              a.btn(href=`/relatorios?ano=${anoOpcao}` class=ano === anoOpcao ? 'btn-primary' : 'btn-outline-primary') #{anoOpcao}

  //- Cards de resumo anual
  .row.g-3.mb-4
    .col-lg-4.col-md-4
      .card.h-100.border-0.shadow-sm
        .card-body
          .d-flex.align-items-center
            .flex-shrink-0
              .bg-success.bg-opacity-10.summary-icon-circle
                i.bi.bi-arrow-up-circle.text-success
            .flex-grow-1.ms-3
              p.text-muted.mb-1.small Total Receitas
              h3.text-success.mb-0 #{totalReceitasAno.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
    
    .col-lg-4.col-md-4
      .card.h-100.border-0.shadow-sm
        .card-body
          .d-flex.align-items-center
            .flex-shrink-0
              .bg-danger.bg-opacity-10.summary-icon-circle
                i.bi.bi-arrow-down-circle.text-danger
            .flex-grow-1.ms-3
              p.text-muted.mb-1.small Total Despesas
              h3.text-danger.mb-0 #{totalDespesasAno.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
    
    .col-lg-4.col-md-4
      .card.h-100.border-0.shadow-sm
        .card-body
          .d-flex.align-items-center
            .flex-shrink-0
              .summary-icon-circle(class=saldoAno >= 0 ? 'bg-primary bg-opacity-10' : 'bg-warning bg-opacity-10')
                i.bi.bi-wallet2(class=saldoAno >= 0 ? 'text-primary' : 'text-warning')
            .flex-grow-1.ms-3
              p.text-muted.mb-1.small Saldo Anual
              h3.mb-0(class=saldoAno >= 0 ? 'text-primary' : 'text-warning') #{saldoAno.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}

  //- Gráfico de evolução (largura total)
  .card.mb-4.border-0.shadow-sm
    .card-header.bg-white.border-0.pt-3.pb-0
      .d-flex.justify-content-between.align-items-center
        h6.mb-0
          i.bi.bi-bar-chart-line.me-2.text-primary
          | Evolução Mensal
        span.badge.bg-light.text-dark #{ano}
    .card-body.py-2
      canvas#chartMensal(height="140")

  //- Linha com Top Despesas e Tabela Resumo lado a lado
  .row.g-4
    //- Top 5 Categorias de Despesa
    .col-lg-4
      .card.h-100.border-0.shadow-sm
        .card-header.bg-white.border-0.pt-4.pb-2
          h5.mb-0
            i.bi.bi-trophy.me-2.text-warning
            | Top 5 Despesas
        .card-body
          if topDespesas.length === 0
            .text-center.text-muted.py-5
              i.bi.bi-emoji-smile(style="font-size: 3rem;")
              p.mt-3.mb-0 Sem despesas registadas
          else
            each cat, index in topDespesas
              .d-flex.justify-content-between.align-items-center.py-2(class=index < topDespesas.length - 1 ? 'border-bottom' : '')
                .d-flex.align-items-center
                  .rounded-circle.text-white.d-flex.align-items-center.justify-content-center.me-3(style=`background-color: ${cat.cor}; width: 32px; height: 32px; font-size: 0.85rem; font-weight: bold;`) #{index + 1}
                  span.fw-medium #{cat.nome}
                span.text-danger.fw-bold #{cat.total.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
            
            //- Barra de percentagem visual
            if topDespesas.length > 0
              hr.my-3
              .small.text-muted.mb-2 Proporção das despesas:
              each cat, index in topDespesas
                - const percentagem = totalDespesasAno > 0 ? ((cat.total / totalDespesasAno) * 100).toFixed(1) : 0
                .mb-2
                  .d-flex.justify-content-between.small.mb-1
                    span #{cat.nome}
                    span #{percentagem}%
                  .progress(style="height: 6px;")
                    .progress-bar(role="progressbar" style=`width: ${percentagem}%; background-color: ${cat.cor};`)

    //- Tabela de Resumo Mensal
    .col-lg-8
      .card.h-100.border-0.shadow-sm
        .card-header.bg-white.border-0.pt-4.pb-2
          h5.mb-0
            i.bi.bi-calendar3.me-2.text-info
            | Resumo Mensal Detalhado
        .card-body.p-0
          .table-responsive
            table.table.table-hover.mb-0
              thead
                tr.bg-light
                  th.ps-4 Mês
                  th.text-end Receitas
                  th.text-end Despesas
                  th.text-end Saldo
                  th.text-center(style="width: 120px;") Tendência
              tbody
                each dados, index in dadosMensais
                  - const temDados = dados.receitas > 0 || dados.despesas > 0
                  tr(class=!temDados ? 'text-muted' : '')
                    td.ps-4.fw-medium #{dados.mes}
                    td.text-end
                      if dados.receitas > 0
                        span.text-success
                          i.bi.bi-plus.me-1
                          | #{dados.receitas.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                      else
                        span.text-muted —
                    td.text-end
                      if dados.despesas > 0
                        span.text-danger
                          i.bi.bi-dash.me-1
                          | #{dados.despesas.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                      else
                        span.text-muted —
                    td.text-end
                      if temDados
                        span.fw-bold(class=dados.saldo >= 0 ? 'text-primary' : 'text-warning') #{dados.saldo.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                      else
                        span.text-muted —
                    td.text-center
                      if temDados
                        if dados.saldo > 0
                          span.badge.bg-success.bg-opacity-10.text-success
                            i.bi.bi-arrow-up
                        else if dados.saldo < 0
                          span.badge.bg-danger.bg-opacity-10.text-danger
                            i.bi.bi-arrow-down
                        else
                          span.badge.bg-secondary.bg-opacity-10.text-secondary
                            i.bi.bi-dash
                      else
                        span.text-muted —
              tfoot.bg-light.fw-bold
                tr
                  td.ps-4 Total Anual
                  td.text-end.text-success #{totalReceitasAno.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                  td.text-end.text-danger #{totalDespesasAno.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                  td.text-end(class=saldoAno >= 0 ? 'text-primary' : 'text-warning') #{saldoAno.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                  td.text-center
                    if saldoAno > 0
                      span.badge.bg-success
                        i.bi.bi-check-lg
                    else if saldoAno < 0
                      span.badge.bg-danger
                        i.bi.bi-x-lg
                    else
                      span.badge.bg-secondary
                        i.bi.bi-dash-lg

block scripts
  script.
    const ctx = document.getElementById('chartMensal').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: !{JSON.stringify(dadosMensais.map(d => d.mes))},
        datasets: [
          {
            label: 'Receitas',
            data: !{JSON.stringify(dadosMensais.map(d => d.receitas))},
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
          },
          {
            label: 'Despesas',
            data: !{JSON.stringify(dadosMensais.map(d => d.despesas))},
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
              }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.raw.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
              }
            }
          }
        }
      }
    });

