doctype html
html(lang="pt-PT")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title #{titulo} - FINAXIS
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet")
    link(href="/css/style.css" rel="stylesheet")
    style.
      html, body { background: #f8fafc; }
  body
    nav.navbar.navbar-expand-lg.navbar-dark.bg-dark
      .container
        a.navbar-brand.d-flex.align-items-center(href=utilizador ? "/dashboard" : "/")
          img.navbar-logo(src="/images/logo.svg" alt="FINAXIS" style="height: 90px;")
        button.navbar-toggler(type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav")
          span.navbar-toggler-icon
        #navbarNav.collapse.navbar-collapse
          ul.navbar-nav.ms-auto
            if utilizador
              li.nav-item
                a.nav-link(href="/dashboard" class=(titulo === 'Dashboard' ? 'active' : ''))
                  i.bi.bi-speedometer2.me-1
                  | Dashboard
              li.nav-item
                a.nav-link(href="/transacoes" class=(titulo === 'Transações' ? 'active' : ''))
                  i.bi.bi-list-ul.me-1
                  | Transações
              li.nav-item
                a.nav-link(href="/categorias" class=(titulo === 'Categorias' ? 'active' : ''))
                  i.bi.bi-tags.me-1
                  | Categorias
              li.nav-item
                a.nav-link(href="/orcamentos" class=(titulo === 'Orçamentos' ? 'active' : ''))
                  i.bi.bi-bullseye.me-1
                  | Orçamentos
              li.nav-item
                a.nav-link(href="/relatorios" class=(titulo === 'Relatórios' ? 'active' : ''))
                  i.bi.bi-graph-up.me-1
                  | Relatórios
              li.nav-item.dropdown
                a.nav-link.dropdown-toggle(href="#" role="button" data-bs-toggle="dropdown")
                  i.bi.bi-person-circle.me-1
                  | #{utilizador.nome}
                ul.dropdown-menu.dropdown-menu-end
                  li
                    a.dropdown-item.text-danger(href="#" data-bs-toggle="modal" data-bs-target="#modalEliminarConta")
                      i.bi.bi-trash.me-2
                      | Eliminar Conta
                  li
                    hr.dropdown-divider
                  li
                    a.dropdown-item(href="/auth/sair")
                      i.bi.bi-box-arrow-right.me-2
                      | Sair
            else
              li.nav-item
                a.nav-link(href="/auth/login")
                  i.bi.bi-box-arrow-in-right.me-1
                  | Entrar
              li.nav-item
                a.nav-link(href="/auth/registar")
                  i.bi.bi-person-plus.me-1
                  | Criar Conta

    //- Modal Eliminar Conta
    if utilizador
      .modal.fade#modalEliminarConta(tabindex="-1" aria-labelledby="modalEliminarContaLabel" aria-hidden="true")
        .modal-dialog.modal-dialog-centered
          .modal-content
            .modal-header.bg-danger.text-white
              h5.modal-title#modalEliminarContaLabel
                i.bi.bi-exclamation-triangle.me-2
                | Eliminar Conta
              button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Fechar")
            .modal-body
              .alert.alert-danger.d-flex.align-items-start
                i.bi.bi-exclamation-triangle-fill.me-2.mt-1
                div
                  strong Esta ação é irreversível!
                  p.mb-0.mt-1 Todos os seus dados serão eliminados permanentemente:
                  ul.mb-0.mt-1
                    li Todas as transações
                    li Todas as categorias
                    li A sua conta e dados pessoais
              .mb-3
                label.form-label(for="passwordEliminar") Confirme a sua palavra-passe:
                input.form-control#passwordEliminar(type="password" placeholder="Introduza a sua palavra-passe" required)
              #erroEliminar.text-danger.small.d-none
            .modal-footer
              button.btn.btn-outline-secondary(type="button" data-bs-dismiss="modal")
                i.bi.bi-x.me-1
                | Cancelar
              button.btn.btn-danger#btnEliminarConta(type="button")
                i.bi.bi-trash.me-1
                | Eliminar Permanentemente

    main.container.py-4
      block content

    //- FOOTER COMPLETO (esconder em páginas de auth)
    if !hideFooter
      footer.footer-section
        .container
          .row.g-4.py-5
            //- Logo e Descrição
            .col-lg-4.col-md-6
              .footer-brand
                img(src="/images/logo.svg" alt="FINAXIS" style="height: 50px;")
              p.footer-description.mt-3
                | A forma mais simples e eficaz de gerir as suas finanças pessoais. 
                | Controle receitas, despesas e acompanhe a evolução do seu património.
              .footer-social.mt-4
                a.social-link(href="#" title="Facebook")
                  i.bi.bi-facebook
                a.social-link(href="#" title="Instagram")
                  i.bi.bi-instagram
                a.social-link(href="#" title="LinkedIn")
                  i.bi.bi-linkedin
                a.social-link(href="#" title="Twitter")
                  i.bi.bi-twitter-x

            //- Links Rápidos
            .col-lg-2.col-md-6
              h5.footer-title Links Rápidos
              ul.footer-links
                li
                  a(href="/") Início
                if utilizador
                  li
                    a(href="/dashboard") Dashboard
                  li
                    a(href="/transacoes") Transações
                  li
                    a(href="/auth/sair") Sair
                else
                  li
                    a(href="/auth/login") Entrar
                  li
                    a(href="/auth/registar") Criar Conta

            //- Funcionalidades
            .col-lg-3.col-md-6
              h5.footer-title Funcionalidades
              ul.footer-links
                li
                  a(href="/transacoes") Transações
                li
                  a(href="/categorias") Categorias
                li
                  a(href="/orcamentos") Orçamentos
                li
                  a(href="/relatorios") Relatórios
                li
                  a(href="/dashboard") Análise Financeira

            //- Contacto
            .col-lg-3.col-md-6
              h5.footer-title Contacto
              ul.footer-contact
                li
                  i.bi.bi-envelope.me-2
                  | suporte@finaxis.pt

          //- Linha divisória
          hr.footer-divider

          //- Copyright
          .row.py-3
            .col-md-6
              p.footer-copyright.mb-0
                | © 2026 FINAXIS - Todos os direitos reservados
            .col-md-6.text-md-end
              p.footer-credits.mb-0
                | Desenvolvido por 
                strong Adrian Santos
                |  - 2024019 (DS)

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js")
    script(src="https://cdn.jsdelivr.net/npm/chart.js")

    //- Script para eliminar conta
    if utilizador
      script.
        document.addEventListener('DOMContentLoaded', function() {
          const btnEliminar = document.getElementById('btnEliminarConta');
          if (btnEliminar) {
            btnEliminar.addEventListener('click', async function() {
              const password = document.getElementById('passwordEliminar').value;
              const erroDiv = document.getElementById('erroEliminar');

              if (!password) {
                erroDiv.textContent = 'Introduza a sua palavra-passe.';
                erroDiv.classList.remove('d-none');
                return;
              }

              // Desativar botão durante o pedido
              btnEliminar.disabled = true;
              btnEliminar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> A eliminar...';

              try {
                const response = await fetch('/auth/eliminar-conta', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                  window.location.href = '/?conta_eliminada=1';
                } else {
                  erroDiv.textContent = data.message || 'Erro ao eliminar conta.';
                  erroDiv.classList.remove('d-none');
                  btnEliminar.disabled = false;
                  btnEliminar.innerHTML = '<i class="bi bi-trash me-1"></i> Eliminar Permanentemente';
                }
              } catch (err) {
                erroDiv.textContent = 'Erro de conexão. Tente novamente.';
                erroDiv.classList.remove('d-none');
                btnEliminar.disabled = false;
                btnEliminar.innerHTML = '<i class="bi bi-trash me-1"></i> Eliminar Permanentemente';
              }
            });
          }

          // Limpar modal ao fechar
          const modal = document.getElementById('modalEliminarConta');
          if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
              document.getElementById('passwordEliminar').value = '';
              document.getElementById('erroEliminar').classList.add('d-none');
            });
          }
        });

    block scripts
